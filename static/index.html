<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åª’ä½“æ–‡ä»¶è½¬å½•ä¸ä¼šè®®çºªè¦å·¥å…·</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; background: #f0f2f5; color: #333; min-height: 100vh; }
.container { max-width: 960px; margin: 0 auto; padding: 24px; }
h1 { text-align: center; margin-bottom: 8px; font-size: 1.8rem; color: #1a1a2e; }
.subtitle { text-align: center; color: #666; margin-bottom: 32px; font-size: 0.95rem; }
.card { background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
.card h2 { font-size: 1.1rem; margin-bottom: 16px; color: #1a1a2e; border-left: 4px solid #4361ee; padding-left: 12px; }
.form-row { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
.form-group { flex: 1; min-width: 200px; }
.form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 500; color: #555; }
.form-group select, .form-group input { width: 100%; padding: 10px 12px; border: 1px solid #d9d9d9; border-radius: 8px; font-size: 0.9rem; transition: border-color 0.2s; }
.form-group select:focus, .form-group input:focus { outline: none; border-color: #4361ee; box-shadow: 0 0 0 3px rgba(67,97,238,0.1); }
.vendor-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 4px; }
.badge-asr { background: #e8f5e9; color: #2e7d32; }
.badge-llm { background: #e3f2fd; color: #1565c0; }
.badge-tts { background: #fff3e0; color: #e65100; }
.badge-other { background: #f3e5f5; color: #7b1fa2; }
@keyframes spin { to { transform: rotate(360deg); } }
#process-btn:hover { background: #3a56d4; }
#process-btn:disabled { background: #aaa; cursor: not-allowed; }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ™ï¸ åª’ä½“æ–‡ä»¶è½¬å½•ä¸ä¼šè®®çºªè¦</h1>
  <p class="subtitle">ä¸Šä¼ éŸ³è§†é¢‘æ–‡ä»¶ â†’ ASR è¯­éŸ³è¯†åˆ«ï¼ˆè¯´è¯äººåˆ†ç¦»ï¼‰â†’ LLM ä¼šè®®çºªè¦</p>

  <div id="save-toast" style="display:none;position:fixed;top:20px;right:20px;background:#2e7d32;color:#fff;padding:8px 16px;border-radius:8px;font-size:0.85rem;z-index:999;transition:opacity 0.3s;">âœ… å·²è‡ªåŠ¨ä¿å­˜</div>

  <!-- Upload & Process (FIRST â€” core feature) -->
  <div class="card">
    <h2>ğŸ“ ä¸Šä¼ æ–‡ä»¶å¹¶å¤„ç†</h2>
    <div class="form-row">
      <div class="form-group" style="flex:2;">
        <label>é€‰æ‹©éŸ³è§†é¢‘æ–‡ä»¶</label>
        <input type="file" id="media-file" accept=".mp3,.mp4,.wav,.m4a,.webm,.ogg,.flac,.mpeg,.mpga" style="padding:8px;">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>ASR ä¾›åº”å•†ï¼ˆè¯­éŸ³è½¬æ–‡å­— + è¯´è¯äººåˆ†ç¦»ï¼‰</label>
        <select id="asr-vendor"><option value="">-- è¯·é€‰æ‹© --</option></select>
        <div id="asr-no-vendor" style="display:none;font-size:0.8rem;color:#e65100;margin-top:4px;">âš ï¸ æš‚æ— å·²é…ç½®çš„ ASR ä¾›åº”å•†ï¼Œè¯·å…ˆåœ¨ä¸‹æ–¹é…ç½®å‡­è¯</div>
      </div>
      <div class="form-group">
        <label>LLM ä¾›åº”å•†ï¼ˆä¼šè®®çºªè¦ï¼‰</label>
        <select id="llm-vendor"><option value="">-- è¯·é€‰æ‹© --</option></select>
        <div id="llm-no-vendor" style="display:none;font-size:0.8rem;color:#e65100;margin-top:4px;">âš ï¸ æš‚æ— å·²é…ç½®çš„ LLM ä¾›åº”å•†ï¼Œè¯·å…ˆåœ¨ä¸‹æ–¹é…ç½®å‡­è¯</div>
      </div>
    </div>
    <button id="process-btn" onclick="processFile()" style="width:100%;padding:12px;background:#4361ee;color:#fff;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:background 0.2s;">
      ğŸš€ å¼€å§‹å¤„ç†
    </button>
    <!-- Progress bar -->
    <div id="progress-container" style="display:none;margin-top:16px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <div id="progress-spinner" style="width:18px;height:18px;border:2px solid #4361ee;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
        <span id="progress-text" style="font-size:0.88rem;color:#555;"></span>
      </div>
      <div style="background:#e9ecef;border-radius:6px;height:8px;overflow:hidden;">
        <div id="progress-bar" style="height:100%;background:linear-gradient(90deg,#4361ee,#7c3aed);border-radius:6px;width:0%;transition:width 0.5s ease;"></div>
      </div>
      <!-- Step indicators -->
      <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.78rem;color:#999;">
        <span id="step-upload">â³ ä¸Šä¼ </span>
        <span id="step-asr">â³ ASR è½¬å½•</span>
        <span id="step-llm">â³ LLM ä¼šè®®çºªè¦</span>
        <span id="step-done">â³ å®Œæˆ</span>
      </div>
    </div>
  </div>

  <!-- Results (shown incrementally) -->
  <div class="card" id="results-card" style="display:none;">
    <h2>ğŸ“ å¤„ç†ç»“æœ</h2>
    <div id="task-id-display" style="font-size:0.82rem;color:#888;margin-bottom:12px;"></div>
    <div id="transcript-section" style="margin-bottom:16px;display:none;">
      <label style="font-weight:600;color:#555;display:block;margin-bottom:8px;cursor:pointer;user-select:none;" onclick="toggleTranscript()">è½¬å½•æ–‡æœ¬ <span id="asr-vendor-tag" style="font-size:0.78rem;color:#2e7d32;"></span> <span id="transcript-toggle" style="font-size:0.78rem;color:#888;margin-left:4px;">â–² æ”¶èµ·</span></label>
      <div id="transcript-meta" style="display:none;font-size:0.82rem;color:#666;margin-bottom:8px;padding:6px 12px;background:#e8f5e9;border-radius:6px;"></div>
      <div id="transcript-output" style="background:#f8f9fa;padding:16px;border-radius:8px;max-height:500px;overflow-y:auto;font-size:0.9rem;line-height:1.6;border:1px solid #e9ecef;"></div>
    </div>
    <div id="summary-section" style="display:none;">
      <label style="font-weight:600;color:#555;display:block;margin-bottom:8px;cursor:pointer;user-select:none;" onclick="toggleSummary()">ä¼šè®®çºªè¦ <span id="llm-vendor-tag" style="font-size:0.78rem;color:#1565c0;"></span> <span id="summary-toggle" style="font-size:0.78rem;color:#888;margin-left:4px;">â–² æ”¶èµ·</span></label>
      <div id="summary-output" style="background:#f0f4ff;padding:16px;border-radius:8px;max-height:600px;overflow-y:auto;font-size:0.9rem;line-height:1.6;border:1px solid #d6e0ff;"></div>
    </div>
  </div>

  <!-- Task History (collapsible) -->
  <div class="card">
    <h2 style="cursor:pointer;user-select:none;" onclick="toggleHistory()">
      ğŸ“‚ å†å²ä»»åŠ¡ <span id="history-toggle" style="font-size:0.85rem;color:#888;margin-left:8px;">â–¼ å±•å¼€</span>
    </h2>
    <div id="task-history" style="display:none;"></div>
  </div>

  <!-- Vendor Key Management (collapsible) -->
  <div class="card" id="creds-card">
    <h2 style="cursor:pointer;user-select:none;" onclick="toggleCreds()">
      ğŸ”‘ ä¾›åº”å•†å‡­è¯ç®¡ç† <span id="creds-toggle" style="font-size:0.85rem;color:#888;margin-left:8px;">â–¼ å±•å¼€</span>
    </h2>
    <p style="font-size:0.85rem;color:#888;margin-bottom:8px;">å‡­è¯ä»…ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œè¾“å…¥å³è‡ªåŠ¨ä¿å­˜ï¼Œåˆ·æ–°é¡µé¢åè‡ªåŠ¨æ¢å¤ã€‚</p>
    <div id="creds-summary" style="font-size:0.85rem;color:#4caf50;margin-bottom:8px;"></div>
    <div id="vendor-keys" style="display:none;"></div>
  </div>

  <!-- Vendor Reference Table -->
  <div class="card">
    <h2>ğŸ“‹ ä¾›åº”å•†èƒ½åŠ›ä¸€è§ˆ</h2>
    <div style="overflow-x:auto;">
      <table id="vendor-table" style="width:100%;border-collapse:collapse;font-size:0.88rem;">
        <thead><tr style="background:#f8f9fa;"><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">ä¾›åº”å•†</th><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">æ”¯æŒçš„äº§å“ç±»å‹</th><th style="padding:10px;text-align:left;border-bottom:2px solid #dee2e6;">æ‰€éœ€å‡­è¯</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<style>
.vendor-section { border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px; transition: border-color 0.2s; }
.vendor-section:hover { border-color: #4361ee; }
.vendor-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.vendor-fields { display: flex; gap: 12px; flex-wrap: wrap; }
.vendor-fields .field-item { flex: 1; min-width: 180px; }
.vendor-fields .field-item label { font-size: 0.8rem; color: #777; margin-bottom: 4px; display: block; }
.vendor-fields .field-item input { width: 100%; padding: 8px 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 0.85rem; }
.vendor-fields .field-item input:focus { outline: none; border-color: #4361ee; box-shadow: 0 0 0 2px rgba(67,97,238,0.1); }
.optional-tag { font-size: 0.7rem; color: #aaa; margin-left: 2px; }
.filled-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: auto; }
.filled-yes { background: #4caf50; }
.filled-no { background: #e0e0e0; }
/* Diarized transcript segments */
.diarized-segment { margin-bottom: 10px; padding: 8px 12px; border-left: 3px solid #4361ee; background: #fff; border-radius: 0 6px 6px 0; }
.diarized-segment .seg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.diarized-segment .seg-speaker { font-weight: 600; font-size: 0.85rem; color: #4361ee; }
.diarized-segment .seg-time { font-size: 0.75rem; color: #999; font-family: monospace; }
.diarized-segment .seg-text { font-size: 0.9rem; color: #333; line-height: 1.5; }
.diarized-segment:nth-child(even) { border-left-color: #7c3aed; }
.diarized-segment:nth-child(even) .seg-speaker { color: #7c3aed; }
.diarized-segment:nth-child(odd):nth-child(n+3) { border-left-color: #e65100; }
.diarized-segment:nth-child(odd):nth-child(n+3) .seg-speaker { color: #e65100; }
/* Speaker color palette */
.spk-1 { border-left-color: #4361ee; } .spk-1 .seg-speaker { color: #4361ee; }
.spk-2 { border-left-color: #7c3aed; } .spk-2 .seg-speaker { color: #7c3aed; }
.spk-3 { border-left-color: #e65100; } .spk-3 .seg-speaker { color: #e65100; }
.spk-4 { border-left-color: #00838f; } .spk-4 .seg-speaker { color: #00838f; }
.spk-5 { border-left-color: #ad1457; } .spk-5 .seg-speaker { color: #ad1457; }
/* Markdown rendering in summary */
#summary-output h1, #summary-output h2, #summary-output h3 { margin: 12px 0 6px; color: #1a1a2e; }
#summary-output h1 { font-size: 1.2rem; } #summary-output h2 { font-size: 1.05rem; } #summary-output h3 { font-size: 0.95rem; }
#summary-output ul, #summary-output ol { padding-left: 20px; margin: 6px 0; }
#summary-output li { margin-bottom: 4px; }
#summary-output p { margin: 6px 0; }
#summary-output strong { color: #1a1a2e; }
#summary-output table { border-collapse: collapse; width: 100%; margin: 8px 0; }
#summary-output th, #summary-output td { border: 1px solid #d6e0ff; padding: 6px 10px; text-align: left; font-size: 0.85rem; }
#summary-output th { background: #e8eaf6; }
</style>
<script>
let VENDORS = {};
let saveTimeout = null;
let credsExpanded = false;

async function init() {
  const resp = await fetch("/api/vendors");
  VENDORS = await resp.json();
  renderVendorKeys();
  renderVendorTable();
  populateSelects();
  updateCredsSummary();
}

function getStoredCreds() {
  try { return JSON.parse(localStorage.getItem("vendor_creds") || "{}"); } catch { return {}; }
}

function saveCred(vendor, fieldKey, value) {
  const all = getStoredCreds();
  if (!all[vendor]) all[vendor] = {};
  all[vendor][fieldKey] = value;
  localStorage.setItem("vendor_creds", JSON.stringify(all));
  updateFilledIndicator(vendor);
  populateSelects();
  updateCredsSummary();
  showToast();
}

function showToast() {
  const toast = document.getElementById("save-toast");
  toast.style.display = "block";
  toast.style.opacity = "1";
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => { toast.style.opacity = "0"; setTimeout(() => toast.style.display = "none", 300); }, 1200);
}

function isVendorReady(vendor) {
  const info = VENDORS[vendor];
  if (!info) return false;
  const creds = getStoredCreds()[vendor] || {};
  const requiredFields = info.fields.filter(f => !f.optional);
  return requiredFields.length > 0 && requiredFields.every(f => creds[f.key] && creds[f.key].trim());
}

function updateCredsSummary() {
  const ready = Object.keys(VENDORS).filter(v => isVendorReady(v));
  const el = document.getElementById("creds-summary");
  if (ready.length === 0) {
    el.innerHTML = '<span style="color:#e65100;">å°šæœªé…ç½®ä»»ä½•ä¾›åº”å•†å‡­è¯</span>';
  } else {
    el.innerHTML = `å·²é…ç½®: ${ready.join(", ")}`;
  }
}

function toggleCreds() {
  credsExpanded = !credsExpanded;
  document.getElementById("vendor-keys").style.display = credsExpanded ? "block" : "none";
  document.getElementById("creds-toggle").textContent = credsExpanded ? "â–² æ”¶èµ·" : "â–¼ å±•å¼€";
}

function updateFilledIndicator(vendor) {
  const dot = document.getElementById(`indicator-${CSS.escape(vendor)}`);
  if (dot) {
    const ready = isVendorReady(vendor);
    dot.className = "filled-indicator " + (ready ? "filled-yes" : "filled-no");
    dot.title = ready ? "å‡­è¯å·²å¡«å†™å®Œæ•´" : "è¿˜æœ‰å¿…å¡«é¡¹æœªå¡«å†™";
  }
}

function renderVendorKeys() {
  const container = document.getElementById("vendor-keys");
  const creds = getStoredCreds();
  container.innerHTML = Object.entries(VENDORS).map(([vendor, info]) => {
    const vc = creds[vendor] || {};
    const fieldsHtml = info.fields.map(f => {
      const val = vc[f.key] || "";
      const optTag = f.optional ? '<span class="optional-tag">(é€‰å¡«)</span>' : '';
      const inputType = "text";
      const maskStyle = (f.secret !== false) ? ' style="-webkit-text-security: disc;"' : '';
      return `<div class="field-item">
        <label>${f.label}${optTag}</label>
        <input type="${inputType}"${maskStyle} placeholder="${f.placeholder || ''}" value="${val}"
          oninput="saveCred('${vendor}', '${f.key}', this.value)">
      </div>`;
    }).join("");
    const noteHtml = info.note ? `<div style="font-size:0.78rem;color:#e65100;margin-top:6px;">ğŸ“Œ ${info.note}</div>` : "";
    return `<div class="vendor-section">
      <div class="vendor-name">
        ${vendor}
        <span style="font-size:0.75rem;color:#999;">${info.types.join(" / ")}</span>
        <span class="filled-indicator filled-no" id="indicator-${CSS.escape(vendor)}"></span>
      </div>
      <div class="vendor-fields">${fieldsHtml}</div>
      ${noteHtml}
    </div>`;
  }).join("");
  Object.keys(VENDORS).forEach(v => updateFilledIndicator(v));
}

function populateSelects() {
  const asrSel = document.getElementById("asr-vendor");
  const llmSel = document.getElementById("llm-vendor");
  const asrPrev = asrSel.value;
  const llmPrev = llmSel.value;

  asrSel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
  llmSel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

  let asrCount = 0, llmCount = 0;
  Object.entries(VENDORS).forEach(([name, info]) => {
    if (info.types.includes("ASR") && isVendorReady(name)) {
      asrSel.innerHTML += `<option value="${name}">${name}</option>`;
      asrCount++;
    }
    if (info.types.includes("LLM") && isVendorReady(name)) {
      llmSel.innerHTML += `<option value="${name}">${name}</option>`;
      llmCount++;
    }
  });

  // Restore previous selection if still available
  if (asrPrev) asrSel.value = asrPrev;
  if (llmPrev) llmSel.value = llmPrev;

  document.getElementById("asr-no-vendor").style.display = asrCount === 0 ? "block" : "none";
  document.getElementById("llm-no-vendor").style.display = llmCount === 0 ? "block" : "none";
}

function renderVendorTable() {
  const tbody = document.querySelector("#vendor-table tbody");
  tbody.innerHTML = Object.entries(VENDORS).map(([name, info]) => `
    <tr style="border-bottom:1px solid #f0f0f0;">
      <td style="padding:10px;font-weight:500;">${name}</td>
      <td style="padding:10px;">${info.types.map(t => {
        const cls = t === "ASR" ? "badge-asr" : t === "LLM" ? "badge-llm" : t === "TTS" ? "badge-tts" : "badge-other";
        return `<span class="vendor-badge ${cls}">${t}</span>`;
      }).join(" ")}</td>
      <td style="padding:10px;font-size:0.82rem;color:#666;">${info.fields.map(f => f.label + (f.optional ? '(é€‰å¡«)' : '')).join(", ")}</td>
    </tr>
  `).join("");
}

function getVendorCreds(vendor) {
  return getStoredCreds()[vendor] || {};
}

function renderTranscript(text) {
  const output = document.getElementById("transcript-output");
  const meta = document.getElementById("transcript-meta");
  try {
    const data = JSON.parse(text);
    if (data.segments && Array.isArray(data.segments)) {
      // Show metadata
      if (data.metadata) {
        const lang = data.metadata.language || "æœªçŸ¥";
        const speakers = data.metadata.total_speakers || "?";
        meta.innerHTML = `ğŸ—£ï¸ è¯†åˆ«åˆ° <strong>${speakers}</strong> ä½è¯´è¯äºº Â· è¯­è¨€: ${lang}`;
        meta.style.display = "block";
      }
      // Render diarized segments
      output.innerHTML = data.segments.map(seg => {
        const spkNum = parseInt((seg.speaker || "").replace(/\D/g, "")) || 1;
        const spkClass = `spk-${Math.min(spkNum, 5)}`;
        return `<div class="diarized-segment ${spkClass}">
          <div class="seg-header">
            <span class="seg-speaker">${escapeHtml(seg.speaker)}</span>
            <span class="seg-time">${escapeHtml(seg.start_time)} â†’ ${escapeHtml(seg.end_time)}</span>
          </div>
          <div class="seg-text">${escapeHtml(seg.text)}</div>
        </div>`;
      }).join("");
      return;
    }
  } catch (e) { /* not JSON, render as plain text */ }
  meta.style.display = "none";
  output.innerHTML = `<div style="white-space:pre-wrap;">${escapeHtml(text)}</div>`;
}

function escapeHtml(str) {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}

function renderMarkdown(text) {
  // Simple Markdown â†’ HTML renderer for meeting minutes
  let html = escapeHtml(text);
  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Unordered lists
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
  // Ordered lists
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  // Horizontal rule
  html = html.replace(/^---$/gm, '<hr style="border:none;border-top:1px solid #d6e0ff;margin:12px 0;">');
  // Line breaks â†’ paragraphs (double newline)
  html = html.replace(/\n\n/g, '</p><p>');
  html = html.replace(/\n/g, '<br>');
  html = `<p>${html}</p>`;
  // Clean up empty paragraphs
  html = html.replace(/<p>\s*<\/p>/g, '');
  html = html.replace(/<p>\s*(<h[123]>)/g, '$1');
  html = html.replace(/(<\/h[123]>)\s*<\/p>/g, '$1');
  html = html.replace(/<p>\s*(<ul>)/g, '$1');
  html = html.replace(/(<\/ul>)\s*<\/p>/g, '$1');
  html = html.replace(/<p>\s*(<hr[^>]*>)\s*<\/p>/g, '$1');
  return html;
}

function validateVendorCreds(vendor) {
  const info = VENDORS[vendor];
  const creds = getVendorCreds(vendor);
  const missing = info.fields.filter(f => !f.optional && (!creds[f.key] || !creds[f.key].trim()));
  if (missing.length > 0) return `${vendor} ç¼ºå°‘å¿…å¡«å‡­è¯: ${missing.map(f => f.label).join(", ")}`;
  return null;
}

function setStep(stepId, status) {
  const el = document.getElementById(stepId);
  if (!el) return;
  if (status === 'active') el.textContent = el.textContent.replace(/^./, 'ğŸ”„');
  else if (status === 'done') el.textContent = el.textContent.replace(/^./, 'âœ…');
  else if (status === 'error') el.textContent = el.textContent.replace(/^./, 'âŒ');
}

async function processFile() {
  const fileInput = document.getElementById("media-file");
  const asrVendor = document.getElementById("asr-vendor").value;
  const llmVendor = document.getElementById("llm-vendor").value;

  if (!fileInput.files.length) return alert("è¯·é€‰æ‹©ä¸€ä¸ªéŸ³è§†é¢‘æ–‡ä»¶");
  if (!asrVendor) return alert("è¯·é€‰æ‹© ASR ä¾›åº”å•†");
  if (!llmVendor) return alert("è¯·é€‰æ‹© LLM ä¾›åº”å•†");

  const asrErr = validateVendorCreds(asrVendor);
  if (asrErr) return alert(asrErr);
  const llmErr = validateVendorCreds(llmVendor);
  if (llmErr) return alert(llmErr);

  const btn = document.getElementById("process-btn");
  const progressContainer = document.getElementById("progress-container");
  const progressBar = document.getElementById("progress-bar");
  const progressText = document.getElementById("progress-text");
  btn.disabled = true;
  progressContainer.style.display = "block";
  progressBar.style.width = "5%";
  progressText.textContent = "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...";

  // Reset steps
  ["step-upload","step-asr","step-llm","step-done"].forEach(s => {
    const el = document.getElementById(s);
    if (el) el.textContent = el.textContent.replace(/^./, 'â³');
  });
  setStep("step-upload", "active");

  // Reset results
  document.getElementById("results-card").style.display = "none";
  document.getElementById("transcript-section").style.display = "none";
  document.getElementById("summary-section").style.display = "none";
  document.getElementById("transcript-output").textContent = "";
  document.getElementById("transcript-meta").style.display = "none";
  document.getElementById("summary-output").textContent = "";
  document.getElementById("task-id-display").textContent = "";
  document.getElementById("asr-vendor-tag").textContent = "";
  document.getElementById("llm-vendor-tag").textContent = "";

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  formData.append("asr_vendor", asrVendor);
  formData.append("asr_creds", JSON.stringify(getVendorCreds(asrVendor)));
  formData.append("llm_vendor", llmVendor);
  formData.append("llm_creds", JSON.stringify(getVendorCreds(llmVendor)));

  try {
    const resp = await fetch("/api/process", { method: "POST", body: formData });
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      // Parse SSE events from buffer
      const lines = buffer.split("\n");
      buffer = lines.pop() || "";

      let eventType = "";
      for (const line of lines) {
        if (line.startsWith("event: ")) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith("data: ") && eventType) {
          const data = JSON.parse(line.slice(6));
          handleSSE(eventType, data, asrVendor, llmVendor);
          eventType = "";
        }
      }
    }
  } catch (e) {
    alert("è¯·æ±‚å¤±è´¥: " + e.message);
  } finally {
    btn.disabled = false;
    document.getElementById("progress-spinner").style.display = "none";
  }
}

function handleSSE(event, data, asrVendor, llmVendor) {
  const progressBar = document.getElementById("progress-bar");
  const progressText = document.getElementById("progress-text");

  if (event === "progress") {
    progressBar.style.width = data.percent + "%";
    progressText.textContent = data.message;
    if (data.step === "upload") { setStep("step-upload", "done"); setStep("step-asr", "active"); }
    if (data.step === "asr_done") { setStep("step-asr", "done"); setStep("step-llm", "active"); }
    if (data.step === "llm_done") { setStep("step-llm", "done"); }
  } else if (event === "transcript") {
    document.getElementById("results-card").style.display = "block";
    document.getElementById("transcript-section").style.display = "block";
    renderTranscript(data.text);
    document.getElementById("asr-vendor-tag").textContent = `(${asrVendor})`;
    document.getElementById("results-card").scrollIntoView({ behavior: "smooth" });
  } else if (event === "summary") {
    document.getElementById("summary-section").style.display = "block";
    document.getElementById("summary-output").innerHTML = renderMarkdown(data.text);
    document.getElementById("llm-vendor-tag").textContent = `(${llmVendor})`;
  } else if (event === "done") {
    progressBar.style.width = "100%";
    progressBar.style.background = "linear-gradient(90deg,#2e7d32,#4caf50)";
    progressText.textContent = "âœ… " + data.message;
    document.getElementById("task-id-display").textContent = `ä»»åŠ¡ID: ${data.task_id}`;
    setStep("step-done", "done");
    document.getElementById("progress-spinner").style.display = "none";
    loadTaskHistory();
  } else if (event === "error") {
    progressBar.style.width = "100%";
    progressBar.style.background = "#e65100";
    progressText.textContent = "âŒ " + data.message;
    document.getElementById("progress-spinner").style.display = "none";
    setStep("step-done", "error");
  }
}

let summaryExpanded = true;

function toggleSummary() {
  summaryExpanded = !summaryExpanded;
  document.getElementById("summary-output").style.display = summaryExpanded ? "block" : "none";
  document.getElementById("summary-toggle").textContent = summaryExpanded ? "â–² æ”¶èµ·" : "â–¼ å±•å¼€";
}

let transcriptExpanded = true;

function toggleTranscript() {
  transcriptExpanded = !transcriptExpanded;
  document.getElementById("transcript-output").style.display = transcriptExpanded ? "block" : "none";
  document.getElementById("transcript-toggle").textContent = transcriptExpanded ? "â–² æ”¶èµ·" : "â–¼ å±•å¼€";
}

let historyExpanded = false;

function toggleHistory() {
  historyExpanded = !historyExpanded;
  document.getElementById("task-history").style.display = historyExpanded ? "block" : "none";
  document.getElementById("history-toggle").textContent = historyExpanded ? "â–² æ”¶èµ·" : "â–¼ å±•å¼€";
  if (historyExpanded) loadTaskHistory();
}

async function loadTaskHistory() {
  const container = document.getElementById("task-history");
  try {
    const resp = await fetch("/api/tasks");
    const tasks = await resp.json();
    if (tasks.length === 0) {
      container.innerHTML = '<p style="color:#999;font-size:0.85rem;padding:8px 0;">æš‚æ— å†å²ä»»åŠ¡</p>';
      return;
    }
    container.innerHTML = tasks.map(t => {
      const status = t.error ? 'âŒ å¤±è´¥' : 'âœ… æˆåŠŸ';
      const statusColor = t.error ? '#e65100' : '#2e7d32';
      return `<div style="border:1px solid #e9ecef;border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;" onclick="loadTask('${t.task_id}')">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-weight:500;font-size:0.9rem;">${t.source_file || 'æœªçŸ¥æ–‡ä»¶'}</span>
          <span style="font-size:0.78rem;color:${statusColor};">${status}</span>
        </div>
        <div style="font-size:0.78rem;color:#999;margin-top:4px;">
          ${t.task_id} Â· ASR: ${t.asr_vendor} Â· LLM: ${t.llm_vendor}
        </div>
      </div>`;
    }).join("");
  } catch (e) {
    container.innerHTML = '<p style="color:#e65100;font-size:0.85rem;">åŠ è½½å¤±è´¥</p>';
  }
}

async function loadTask(taskId) {
  try {
    const resp = await fetch(`/api/tasks/${taskId}`);
    const data = await resp.json();
    document.getElementById("task-id-display").textContent = `ä»»åŠ¡ID: ${taskId}`;
    if (data.transcript) {
      document.getElementById("transcript-section").style.display = "block";
      renderTranscript(data.transcript);
      document.getElementById("asr-vendor-tag").textContent = data.meta ? `(${data.meta.asr_vendor})` : '';
    }
    if (data.summary) {
      document.getElementById("summary-section").style.display = "block";
      document.getElementById("summary-output").innerHTML = renderMarkdown(data.summary);
      document.getElementById("llm-vendor-tag").textContent = data.meta ? `(${data.meta.llm_vendor})` : '';
    }
    document.getElementById("results-card").style.display = "block";
    document.getElementById("results-card").scrollIntoView({ behavior: "smooth" });
  } catch (e) {
    alert("åŠ è½½ä»»åŠ¡å¤±è´¥: " + e.message);
  }
}

init();
</script>
</body>
</html>
